<html>
    <head>
        <title>Ludum Dare 31</title>
        <style>
            body { margin: 0; }
            canvas { width: 100%; height: 100% }
        </style>
    </head>
    <body>
        <script src="three.min.js"></script>
        <script src="tween.min.js"></script>
        <script>
            var scene = new THREE.Scene();
            var camera = new THREE.PerspectiveCamera( 30, window.innerWidth/window.innerHeight, 0.1, 1000 );
            var renderer = new THREE.WebGLRenderer();
            renderer.setSize( window.innerWidth, window.innerHeight );
            document.body.appendChild( renderer.domElement );

            var table_geo = new THREE.BoxGeometry( 10, 10, 0 );
            var table_mat = new THREE.MeshBasicMaterial( { color: 0xaaaaaa } );
            var table = new THREE.Mesh( table_geo, table_mat );
            scene.add( table );

            var plane_geo  = new THREE.BoxGeometry( 12, 12, 0.1 );
            var card_plane = new THREE.Mesh( plane_geo, table_mat );
            card_plane.visible=false;
            scene.add( card_plane );


            function new_card(x,y, facing){
                facing  *= 3.14;
                var card_geo = new THREE.BoxGeometry( 0.71, 1, 0 );
                var card_mat = new THREE.MeshBasicMaterial({
                                color: 0xffffff,
                                map: THREE.ImageUtils.loadTexture('pokemon.jpg')
                        });
                var card = new THREE.Mesh( card_geo, card_mat );
                card.position.set(x,y,0.1);
                card.rotation.set(0,0,facing);

                card.moveTo = function(position,rotation){
                    card.tpos = {x:card.position.x, y:card.position.y, z:card.position.z,
                                 rx:card.rotation.x, ry:card.rotation.y, rz:card.rotation.z};
                    card.targ = {x:position.x, y:position.y, z:position.z,
                                rx:rotation.x, ry:rotation.y, rz:rotation.z};
                    card.tween = new TWEEN.Tween(card.tpos).to(card.targ,300);
                    card.tween.onUpdate(function(){
                        card.position.set(card.tpos.x, card.tpos.y, card.tpos.z);
                        card.rotation.set(card.tpos.rx, card.tpos.ry, card.tpos.rz);
                    });
                    card.tween.easing(TWEEN.Easing.Circular.Out);
                    card.tween.start();
                }

                card.showcase = function(){
                    if (card.showcased){
                        card.showcased = false;
                        card.moveTo(new THREE.Vector3(x,y,0.1), new THREE.Vector3(0,0,facing));
                    } else {
                        // move to the showcase position
                        card.showcased = true;
                        // The new position will be right in front of the camera
                        var new_pos = camera.position.clone().negate().normalize().multiplyScalar(75/camera.fov).add(camera.position);
                        card.moveTo(new_pos, camera.rotation);
                    }
                    
                };
                card.return = function(){
                    card.showcased = false;
                    card.moveTo(new THREE.Vector3(x,y,0.1), new THREE.Vector3(0,0,facing));
                };
                return card;
            }

            var cards = [
                            new_card(-1,-3, false),
                            new_card(0,-3,  false),
                            new_card(1,-3,  false),
                            new_card(0,0,   0.5),
                            new_card(-1,3,  true),
                            new_card(0,3,   true),
                            new_card(1,3,   true),
                        ];

            for (i in cards){
                scene.add( cards[i] );
            }

            camera.position.set(0,-10,6);
            camera.lookAt( new THREE.Vector3( 0, 0, 0 ));

            var raycaster = new THREE.Raycaster();

            document.addEventListener( 'mousedown', onDocumentMouseDown, false );
            document.addEventListener( 'mouseup',   onDocumentMouseUp, false );
            document.addEventListener( 'mousemove', onDocumentMouseMove, false );
            document.addEventListener( 'touchstart', onDocumentMouseDown, false );
            document.addEventListener( 'touchend',   onDocumentMouseUp, false );
            document.addEventListener( 'touchmove', onDocumentMouseMove, false );
            window.addEventListener( 'resize', onWindowResize, false );

            function onWindowResize() {

                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize( window.innerWidth, window.innerHeight );

            }

            function onDocumentMouseDown( event ) {
                event.preventDefault();
                var inter = intersection(event, cards);
                if (inter){
                    window.card = inter.object;
                    window.card.offset = inter.point.clone().sub( window.card.position );
                }
            }

            function onDocumentMouseMove( event ) {
                event.preventDefault();

                if (window.card){
                    new_pos = intersection(event, [card_plane]).point.sub(window.card.offset);
                    window.card.position.set( new_pos.x, new_pos.y, new_pos.z );
                    window.moved = true;
                }
                
            }

            function onDocumentMouseUp( event ) {
                event.preventDefault();
                var card = intersection(event, cards).object;
                if (!window.moved && card && window.card == card){
                    card.showcase();
                } else if (window.moved) {
                    card.return();
                }
                window.card = undefined;
                window.moved = false;
            }

            function intersection(event, thing){
                // if it's a touch event, check event.changedTouches[0].clientX
                if (event.changedTouches){ 
                    event.clientX = event.changedTouches[0].clientX;
                    event.clientY = event.changedTouches[0].clientY;
                }

                var mouse = new THREE.Vector2();
                mouse.x =  (event.clientX / window.innerWidth)*2 - 1;
                mouse.y = -(event.clientY / window.innerHeight)*2 + 1;
                var vector = new THREE.Vector3( mouse.x, mouse.y, 0.5 ).unproject( camera );

                raycaster.ray.set( camera.position, vector.sub( camera.position ).normalize() );

                var intersects = raycaster.intersectObjects( thing );

                if ( intersects.length > 0 ) {
                    return intersects[ 0 ];
                }
            }


            var render = function () {
                TWEEN.update();
                requestAnimationFrame( render );
                renderer.render(scene, camera);
            };
            render();
        </script>
    </body>
</html>