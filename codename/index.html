<!DOCTYPE html>
<html>
<title>Codename</title>
<content>

<div data-bind="foreach: words" class="container">
    <div class="box mui-btn mui-btn--large" data-bind="css: current_colour, click: choose">
        <span class="text" data-bind="text: word"></span>
    </div>
</div>

<div class="corner">
    <div data-bind="click: close" class="eye mui-btn mui-btn--large mui-btn--fab">
        <i class="fa fa-lg fa-times" aria-hidden="true"></i>
    </div>
    <div data-bind="click: showall" class="eye mui-btn mui-btn--large mui-btn--fab">
        <i class="fa fa-lg" data-bind="css: eye" aria-hidden="true"></i>
    </div>
    <div data-bind="click: refresh" class="refresh mui-btn mui-btn--large mui-btn--fab">
        <i class="fa fa-lg fa-refresh" data-bind="css: spin" aria-hidden="true"></i>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.0/knockout-min.js"></script>
<link href="//cdn.muicss.com/mui-0.5.3/css/mui.min.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
<script src="//cdn.muicss.com/mui-0.5.3/js/mui.min.js"></script>
<script type="text/javascript" src="data.js"></script>
<script type="text/javascript" src="seedrandom.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script type="text/javascript">
window.onload = function () {
    function manager() {
        var self = this;
        
        var seed = window.location.hash.split('#')[1];
        Math.seedrandom(seed);
        data = shuffle(data).slice(0,25);

        self.words = ko.observableArray();
        self.spin = ko.observable('');
        self.eye = ko.observable('fa-eye');
        var colours = shuffle([0,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3]);

        data.forEach(function(word, i){
            var colour = ['assassin', 'neutral', 'mui-btn--primary', 'mui-btn--danger'][colours[i]]
            var chosen = ko.observable(false);
            var peeked = ko.observable(false);
            var current_colour = ko.pureComputed(function() {
                if (chosen() != peeked()){
                    return colour;
                } else {
                    return 'mui-btn--raised gray'
                }
            }, this);
            self.words.push({
                word: word,
                colour: colour,
                chosen: chosen,
                peeked: peeked,
                current_colour: current_colour,
                choose: function(refresh){
                    chosen(!chosen());
                    self.spin('fa-spin');
                }
            });
        })

        self.showall = function(){
            self.words().forEach(function(v){
                v.peeked(!v.peeked());
            });
            if (self.eye() == 'fa-eye'){
                self.eye('fa-eye-slash');
            } else {
                self.eye('fa-eye');
            }
        }
        self.close = function(){
            self.words().forEach(function(v){
                v.peeked(false);
                v.chosen(false);
            });
            $.ajax({
                url: '//hook.io/datastore/set?key=codename'+seed,
                data: {
                    value: '0000000000000000000000000'
                },
                method: 'POST'
            });
        }
        self.refresh = function(){
            $.ajax({
                url: '//hook.io/datastore/get?key=codename'+seed,
                method: 'GET',
                success: function(data){
                    console.log(data);
                    self.spin('');
                    message = data.split('');
                    message.pop(); message.shift();
                    if (message.length != 25){
                        message = '0000000000000000000000000'.split('');
                    }
                    self.words().forEach(function(v, i){
                        if (message[i] == '1') {
                            v.chosen(true);
                        }
                        if (v.chosen()){
                            message[i] = '1';
                        }
                    });
                    console.log(message.join(''));
                    $.ajax({
                        url: '//hook.io/datastore/set?key=codename'+seed,
                        data: {
                            value: message.join('')
                        },
                        method: 'POST'
                    });
                }
            });
        }
        self.refresh();
    }
    ko.applyBindings(new manager());
}

function shuffle(array) {
  var currentIndex = array.length, temporaryValue, randomIndex;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;

    // And swap it with the current element.
    temporaryValue = array[currentIndex];
    array[currentIndex] = array[randomIndex];
    array[randomIndex] = temporaryValue;
  }

  return array;
}
</script>

<style type="text/css">
html, body, .container { height: 100%; width: 100%; margin: 0; }

.corner {
    position: absolute;
    bottom: 10px;
    right: 10px;
}
.box {
    height: 19%;
    width: 19%;
    display: inline-block;
    margin: 0 !important;
    padding: 0;
    font-size: 2.1vw;
}
.text {
    position: relative;
    top: 50%;
    transform: translateY(-50%);
    display: block;
    vertical-align: middle;
}
.assassin {
    background-color: black;
}
.assassin span {
    color: white;
}
.assassin:hover {
    background-color: black;
}
.neutral {
    background-color: #FFCE57
}
.neutral:hover {
    background-color: #FFCE57
}

</style>

</content>
</html>